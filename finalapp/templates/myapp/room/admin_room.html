{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load custom_tags %}

{% block title %}Admin Room{% endblock %}

{% block content %}
<head>
    <link rel="stylesheet" href="{% static 'css/admin_room.css' %}">
</head>

<div class="admin-room-container">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h2>

    <div class="room-form-container">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <a href="{% url 'admin_room_add' %}" class="btn add-room-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</a>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á, ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•...">
    </div>

    <div class="table-container">
        <table class="room-table">
            <thead>
                <tr>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡∏Ç‡∏ô‡∏≤‡∏î (‡∏ï‡∏£.‡∏°.)</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="roomTableBody">
                {% for room in rooms %}
                <tr>
                    <td class="room-number">{{ room.room_number }}</td>
                    <td>{{ room.room_type }}</td>
                    <td>{{ room.size|floatformat:0 }} ‡∏ï‡∏£.‡∏°</td>
                    <td>{{ room.rent_price|floatformat:0|intcomma }} ‡∏ö‡∏≤‡∏ó</td>

                    <td>
                        {% if room.id in room_members %}
                            <span class="status-occupied">‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>
                        {% else %}
                            {% if room.status == "available" %}
                                <span class="status-available">‚úÖ ‡∏ß‡πà‡∏≤‡∏á</span>
                            {% elif room.status == "reserved" %}
                                <span class="status-reserved">üî∂ ‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏á</span>
                            {% else %}
                                <span class="status-occupied">‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>
                            {% endif %}
                        {% endif %}
                    </td>

                    <td class="tenant-info">
                        {% if room.id in room_members %}
                            <span class="tenant-name">{{ room_members|dict_get:room.id|attr:"fullname" }}</span><br>
                            <span class="tenant-email">{{ room_members|dict_get:room.id|attr:"email" }}</span>
                        {% else %}
                            <span class="no-tenant">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</span>
                        {% endif %}
                    </td>

                    <td>
                        <div class="actions-container">
                            {% if room.id in room_members %}
                                <a href="{% url 'remove_member' room.id %}" class="btn delete-tenant-btn"
                                   onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?');">
                                   ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤
                                </a>
                            {% else %}
                                <form method="POST" action="{% url 'update_member' room.id %}" class="update-member-form">
                                    {% csrf_token %}
                                    <select name="member_id" class="tenant-select" required>
                                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</option>
                                        {% for member in members %}
                                            <option value="{{ member.id }}">{{ member.fullname }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn add-tenant-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</button>
                                </form>
                            {% endif %}

                            <a href="{% url 'delete_room' room.id %}" class="btn delete-room-btn"
                               onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?');">
                               ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="no-room">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- JavaScript ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <script>
        document.getElementById("searchInput").addEventListener("keyup", function() {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll("#roomTableBody tr");

            rows.forEach(row => {
                let roomNumber = row.querySelector(".room-number")?.textContent.toLowerCase() || "";
                let tenantName = row.querySelector(".tenant-name")?.textContent.toLowerCase() || "";
                let tenantEmail = row.querySelector(".tenant-email")?.textContent.toLowerCase() || "";

                if (roomNumber.includes(filter) || tenantName.includes(filter) || tenantEmail.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    </script>
</div>
{% endblock %}
