{% extends "base.html" %}
{% load static %}

{% block title %}Admin Manage Users{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/adminpage.css' %}">

<div class="content-header">
    <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
</div>

<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-info">
            <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <p>{{ users|length }}</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üëë</div>
        <div class="stat-info">
            <h3>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p>{{ admins_count }}</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üë§</div>
        <div class="stat-info">
            <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
            <p>{{ users_count }}</p>
        </div>
    </div>
</div>

<div class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•...">
</div>

<div class="table-container">
    <table class="user-table">
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            {% for user in users %}
            <tr>
                <td>
                    <a href="#" class="profile-link user-name" data-id="{{ user.id }}">
                      {{ user.fullname }}
                    </a>
                  </td>
                  <td>
                    <a href="#" class="profile-link user-email" data-id="{{ user.id }}">
                      {{ user.email }}
                    </a>
                  </td>
                <td>{{ user.phone }}</td>
                <td>
                    <span class="role-badge {{ user.role }}">
                        {{ user.role|title }}
                    </span>
                </td>
                <td class="action-buttons">
                    {% if user.role != 'admin' %}
                        <a href="{% url 'change_user_role' user.id 'admin' %}" class="btn make-admin">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</a>
                    {% endif %}
                    {% if user.role != 'user' %}
                        <a href="{% url 'change_user_role' user.id 'user' %}" class="btn make-user">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
                    {% endif %}
                    <a href="{% url 'delete_user' user.id %}" class="btn delete-user"
                       onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">‡∏•‡∏ö</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- üîπ Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-inner">
      <span class="close" onclick="closeProfileModal()">&times;</span>
      <img id="profileImg" class="modal-img" src="" alt="profile">
      <h2 id="profileName">‡∏ä‡∏∑‡πà‡∏≠</h2>
      <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="profileEmail"></span></p>
      <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="profilePhone"></span></p>
      <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> <span id="profileAddress"></span></p>
      <p><strong>‡πÄ‡∏û‡∏®:</strong> <span id="profileSex"></span></p>
      <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> <span id="profileBirthday"></span></p>
      <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="profileRole"></span></p>
      <button class="modal-close-btn" onclick="closeProfileModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
  

<!-- üîπ JavaScript -->
<script>
    // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö real-time
    document.getElementById("searchInput").addEventListener("keyup", function () {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll("#userTableBody tr");

        rows.forEach(row => {
            let name = row.querySelector(".profile-link")?.textContent.toLowerCase() || "";
            let email = row.querySelectorAll(".profile-link")[1]?.textContent.toLowerCase() || "";
            row.style.display = (name.includes(filter) || email.includes(filter)) ? "" : "none";
        });
    });

    // üîê ‡∏õ‡∏¥‡∏î modal ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
    function closeProfileModal() {
        document.getElementById("profileModal").style.display = "none";
    }

    // üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ AJAX
    document.querySelectorAll(".profile-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const userId = this.dataset.id;

            fetch(`/menege/get-user-profile/${userId}/`)
                .then(response => {
                    if (!response.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
                    return response.json();
                })
                .then(data => {
                    document.getElementById("profileImg").src = data.profile;
                    document.getElementById("profileName").textContent = data.fullname;
                    document.getElementById("profileEmail").textContent = data.email;
                    document.getElementById("profilePhone").textContent = data.phone;
                    document.getElementById("profileAddress").textContent = data.address;
                    document.getElementById("profileSex").textContent = data.sex;
                    document.getElementById("profileBirthday").textContent = data.birthday;

                    const roleMap = {
                        "admin": "üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö",
                        "user": "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
                    };
                    document.getElementById("profileRole").textContent = roleMap[data.role] || data.role;

                    document.getElementById("profileModal").style.display = "flex";
                })
                .catch(err => {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                    console.error(err);
                });
        });
    });
</script>

{% endblock %}
